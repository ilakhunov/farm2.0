#!/usr/bin/env bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

set -e

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë   –ù–ê–°–¢–†–û–ô–ö–ê –î–õ–Ø –ó–ê–ü–£–°–ö–ê –ù–ê ANDROID –¢–ï–õ–ï–§–û–ù–ï                ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

cd "$(dirname "$0")/../mobile"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
echo "üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤..."
if command -v flutter &> /dev/null; then
    DEVICES=$(flutter devices 2>&1 | grep -E "android|device" | wc -l)
    if [ "$DEVICES" -eq 0 ]; then
        echo "‚ö†Ô∏è  Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!"
        echo ""
        echo "–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω —á–µ—Ä–µ–∑ USB –∏:"
        echo "1. –í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (7 —Ä–∞–∑ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ '–ù–æ–º–µ—Ä —Å–±–æ—Ä–∫–∏')"
        echo "2. –í–∫–ª—é—á–∏—Ç–µ '–û—Ç–ª–∞–¥–∫—É –ø–æ USB' –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞"
        echo "3. –†–∞–∑—Ä–µ—à–∏—Ç–µ –æ—Ç–ª–∞–¥–∫—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ"
        echo ""
        read -p "–ù–∞–∂–º–∏—Ç–µ Enter –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..."
    fi
else
    echo "‚ùå Flutter –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞
IP_ADDR=$(ip addr show 2>/dev/null | grep -E "inet.*192\.168\.|inet.*10\.|inet.*172\.(1[6-9]|2[0-9]|3[01])\." | head -1 | awk '{print $2}' | cut -d/ -f1 || echo "")

if [ -z "$IP_ADDR" ]; then
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å IP –∞–¥—Ä–µ—Å"
    echo "–í–≤–µ–¥–∏—Ç–µ IP –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –≤—Ä—É—á–Ω—É—é:"
    read -p "IP –∞–¥—Ä–µ—Å: " IP_ADDR
fi

echo ""
echo "üåê IP –∞–¥—Ä–µ—Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞: $IP_ADDR"
echo ""

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API URL
ENV_FILE="lib/core/constants/env.dart"
if [ -f "$ENV_FILE" ]; then
    echo "üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API URL..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ —É–∂–µ IP –∞–¥—Ä–µ—Å
    if grep -q "localhost" "$ENV_FILE"; then
        echo "–û–±–Ω–æ–≤–ª—è—é API URL —Å localhost –Ω–∞ $IP_ADDR..."
        sed -i "s|http://localhost:8000|http://$IP_ADDR:8000|g" "$ENV_FILE"
        echo "‚úÖ API URL –æ–±–Ω–æ–≤–ª–µ–Ω"
    else
        echo "‚úÖ API URL —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    fi
    
    echo ""
    echo "–¢–µ–∫—É—â–∏–π API URL:"
    grep "kApiBaseUrl" "$ENV_FILE" | head -1
    echo ""
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ backend
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ backend —Å–µ—Ä–≤–µ—Ä–∞..."
if curl -s "http://$IP_ADDR:8000/health" > /dev/null 2>&1; then
    echo "‚úÖ Backend –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://$IP_ADDR:8000"
else
    echo "‚ö†Ô∏è  Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://$IP_ADDR:8000"
    echo ""
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:"
    echo "1. Backend –∑–∞–ø—É—â–µ–Ω: cd ../backend && poetry run uvicorn app.main:app --host 0.0.0.0 --reload"
    echo "2. Firewall —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç 8000"
    echo ""
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
echo ""
echo "–ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ 'q' –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ."
echo ""

# –ó–∞–ø—É—Å–∫ Flutter
flutter run

